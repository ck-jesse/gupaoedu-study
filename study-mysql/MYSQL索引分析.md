# MYSQL索引分析

## 一、索引是什么

维基百科对数据库索引的定义：

**数据库索引，是数据库管理系统（DBMS）中一个排序的数据结构，以协助快速查询、 更新数据库表中数据。** 

在 InnoDB 里面，索引类型有三种，普通索引、唯一索引（主键索引是特殊的唯一索引）、全文索引。 

**普通索引（Normal）**

> 也叫非唯一索引，是最普通的索引，没有任何的限制。 

**唯一索引（Unique）**：

> 唯一索引要求键值不能重复。另外需要注意的是，主键索引是一种特殊的唯一索引，它还多了一个限制条件，要求键值不能为空。主键索引用 primay key 创建。 

**全文索引（Fulltext）**：

> 针对比较大的数据，比如我们存放的是消息内容，有几 KB 的数 据的这种情况，如果要解决like 查询效率低的问题，可以创建全文索引。只有文本类型 的字段才可以创建全文索引，比如 char、varchar、text。 



## 二、索引存储模型推演



### 1、二叉查找树 BST

BST - Binary Search Tree

> 动图网址： https://www.cs.usfca.edu/~galles/visualization/BST.html 

**特点：**

左子树所有的节点都小于父节点，右子树所有的节点都大于父节点。也就是说二叉查找树是一个有序的线性表。

二叉查找树通过二分查找来查找数据。

![二叉查找树](img/二叉查找树.png)

**优点：**

二叉查找树既能够实现快速查找，又能够实现快速插入。

**缺点：**

查找耗时和树的深度相关，在最坏的情况下时间复杂度会退化成O(n)，也就是退化为了一个链表，这种情况下不能达到加快检索速度的目的，和顺序查找效率是一样的。  因为左右子树深度差太大，导致树的左子树根本没有节点——也就是它不够平衡。



### 2、平衡二叉查找树 AVL Tree

AVL Tree - Balanced Binary Search Trees

> 动图网址： https://www.cs.usfca.edu/~galles/visualization/AVLtree.html 

**平衡二叉查找树的定义：左右子树深度差绝对值不能超过 1。**

#### 2.1 怎么保证树是平衡的呢？

也就是说怎么保证左右子树的深度差不超过 1 呢？

比如按顺序插入 1、2、3、4、5、6。

**1）左旋**

当插入 1、2 之后，如果按照二叉查找树的定义，3 肯定是要在 2 的右边的，这时根节点 1 的右节点深度会变成 2，但是左节点的深度是 0，因为它没有子节点，所以就会违反平衡二叉树的定义。

因为右节点下面接一个右节点，右右型，所以这时我们要把 2 提上去，这个操作叫做左旋。

![左旋](img/左旋.png)

**2）右旋**

同样，插入 6、5、4，这个时候会变成左左型，就会发生右旋操作，把 5 提上去。

![右旋](img/右旋.png)

#### 2.2 索引存储什么内容呢？

在平衡二叉树中，一个节点，它的大小是一个固定的单位，那么作为索引应该存储什么内容？ 

**1）索引的键值**

> 比如我们在 id 上面创建了一个索引，在用 where id =1 的条件查询时就会找到索引里面的 id 的这个键值。 

**2）数据的磁盘地址**

> 索引的作用就是去查找数据的存放地址。 

**3）左右子节点的引用**

> 因为是二叉树，它必须还要有左子节点和右子节点的引用，这样才能找到下一个节点。

**分析**

当我们用树的结构来存储索引的时候，访问一个节点就要跟磁盘之间发生一次 IO。 

InnoDB 操作磁盘的最小的单位是一页（或者叫一个磁盘块），大小是 16K(16384 字节)。 

```sql
-- 查看数据和索引的大小
SELECT
	CONCAT( ROUND( SUM( DATA_LENGTH / 1024 / 1024 ), 2 ), 'MB' ) AS data_len,
	CONCAT( ROUND( SUM( INDEX_LENGTH / 1024 / 1024 ), 2 ), 'MB' ) AS index_len
FROM information_schema.TABLES WHERE table_schema = 'coy' AND table_name = 'user_info';
```

如果我们一个节点只存一个键值+数据+引用，例如整形的字段，可能只用了十几个或者几十个字节，它远远达不到 16K 的容量，所以访问一个树节点，进行一次 IO 的时候，浪费了大量的空间。 

所以如果每个节点存储的数据太少，从索引中找到我们需要的数据，就要访问更多的节点，意味着跟磁盘交互次数就会过多。

**缺点：**

 1、索引节点存储的数据太少，一方面浪费大量空间，另一方面磁盘IO操作次数多，性能低。

2、数据越多树的深度越高，查询性能越低。



### 3、多路平衡查找树 B-Tree

Binary Tree

跟 AVL 树一样，B-Tree 在枝节点和叶子节点存储键值、数据地址、节点引用。

**特点：**

分叉数（路数）永远比关键字数多 1。

分裂：当Max Degree为3时，若新增关键字时数量为3，则需要进行分裂操作。

合并：如果删除节点，则需要进行合并操作。

![B-Tree2](img/B-Tree2.png)

**分析：**

在更新索引的时候会有大量的索引的结构的调整，所以为什么我们建议不要在频繁更新的列上建索引，或者为什么不要更新主键。 

节点的分裂和合并，其实就是 InnoDB 页的分裂和合并。

**优点：**

B-Tree 实现一个节点存储多个关键字

**缺点：**

相对AVL树B-Tree在空间利用率上已经有一定的提升，但因为每个节点存储了数据，所以可存储的键值还是很少，查找时还是会导致磁盘IO操作比较频繁。



### 4、加强版多路平衡查找树 B+Tree

B+Tree

**特点：**



![B+Tree2](img/B+Tree2.png)