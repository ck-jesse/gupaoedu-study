# 压测
# 场景1 - 非同步方式加载数据
## 配置
```yaml
spring:
  application:
    name: study-spring-demo
  cache:
    multi:
      # 一级缓存
      caffeine:
        spec: initialCapacity=10,maximumSize=200,refreshAfterWrite=30s
      # 二级缓存
      redis:
        defaultTimeToLive: 1000
        # 设置缓存名称的过期时间(毫秒)
        expires:
          userCache: 30000
          userCacheSync: 30000
```

```text
// sync=false,即采用非同步方式加载数据
@Cacheable(value = "userCache", key = "#userId")
public User queryUser(String userId) {
    User user = new User(userId, "addr");
    try {
        Thread.sleep(1000);// 模拟加载数据的耗时
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
    logger.info("加载数据:{}", user);
    return user;
}
```

## 测试结果
> sync=false,即采用非同步方式加载数据。
> 
> 通过分析下面的日志发现，存在如下问题：
>
> 1、同一个key在同一时刻会有多个线程去加载数据，在高并发场景下，这是一个典型的同一个key缓存击穿场景。
> 
> 2、`后加载完数据的线程`会覆盖`前面线程加载的数据`，这是一个类似ABA的问题，当然一般情况下，查询到的数据是一样的，但在对数据变更状态要求严格的场景下要特别注意这个点。
>


## 测试日志
### 第一次获取缓存(无缓存项)
```text
2020-05-09 12:10:41.944  INFO 6520 --- [nio-8080-exec-1] c.c.g.s.s.c.c.CacheAutoConfiguration     : [LoadingCache] exec default CacheLoader.load() return null, key=cck
2020-05-09 12:10:41.944 DEBUG 6520 --- [nio-8080-exec-1] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=null
2020-05-09 12:10:41.999  INFO 6520 --- [nio-8080-exec-3] c.c.g.s.s.c.c.CacheAutoConfiguration     : [LoadingCache] exec default CacheLoader.load() return null, key=cck
2020-05-09 12:10:41.999 DEBUG 6520 --- [nio-8080-exec-3] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=null
2020-05-09 12:10:42.199  INFO 6520 --- [nio-8080-exec-2] c.c.g.s.s.c.c.CacheAutoConfiguration     : [LoadingCache] exec default CacheLoader.load() return null, key=cck
2020-05-09 12:10:42.199 DEBUG 6520 --- [nio-8080-exec-2] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=null
2020-05-09 12:10:42.398  INFO 6520 --- [nio-8080-exec-4] c.c.g.s.s.c.c.CacheAutoConfiguration     : [LoadingCache] exec default CacheLoader.load() return null, key=cck
2020-05-09 12:10:42.398 DEBUG 6520 --- [nio-8080-exec-4] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=null
2020-05-09 12:10:42.598  INFO 6520 --- [nio-8080-exec-5] c.c.g.s.s.c.c.CacheAutoConfiguration     : [LoadingCache] exec default CacheLoader.load() return null, key=cck
2020-05-09 12:10:42.598 DEBUG 6520 --- [nio-8080-exec-5] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=null
2020-05-09 12:10:42.950  INFO 6520 --- [nio-8080-exec-1] c.c.g.s.s.cache.CaffeineCacheService     : 加载数据:User(name=cck, addr=addr, currTime=1588997441949)
2020-05-09 12:10:42.950 DEBUG 6520 --- [nio-8080-exec-1] c.c.g.s.s.c.common.CaffeineRedisCache    : put cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997441949)
2020-05-09 12:10:43.000  INFO 6520 --- [nio-8080-exec-3] c.c.g.s.s.cache.CaffeineCacheService     : 加载数据:User(name=cck, addr=addr, currTime=1588997441999)
2020-05-09 12:10:43.000 DEBUG 6520 --- [nio-8080-exec-3] c.c.g.s.s.c.common.CaffeineRedisCache    : put cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997441999)
2020-05-09 12:10:43.041 DEBUG 6520 --- [nio-8080-exec-6] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997441999)
2020-05-09 12:10:43.041 DEBUG 6520 --- [nio-8080-exec-7] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997441999)
2020-05-09 12:10:43.046 DEBUG 6520 --- [nio-8080-exec-9] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997441999)
2020-05-09 12:10:43.046 DEBUG 6520 --- [nio-8080-exec-8] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997441999)
2020-05-09 12:10:43.049 DEBUG 6520 --- [nio-8080-exec-3] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997441999)
2020-05-09 12:10:43.049 DEBUG 6520 --- [io-8080-exec-10] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997441999)
2020-05-09 12:10:43.051 DEBUG 6520 --- [nio-8080-exec-1] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997441999)
2020-05-09 12:10:43.051 DEBUG 6520 --- [nio-8080-exec-7] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997441999)
2020-05-09 12:10:43.054 DEBUG 6520 --- [nio-8080-exec-1] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997441999)
2020-05-09 12:10:43.054 DEBUG 6520 --- [nio-8080-exec-8] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997441999)
2020-05-09 12:10:43.056 DEBUG 6520 --- [nio-8080-exec-9] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997441999)
2020-05-09 12:10:43.056 DEBUG 6520 --- [io-8080-exec-10] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997441999)
2020-05-09 12:10:43.058 DEBUG 6520 --- [nio-8080-exec-9] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997441999)
2020-05-09 12:10:43.058 DEBUG 6520 --- [nio-8080-exec-7] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997441999)
2020-05-09 12:10:43.061 DEBUG 6520 --- [nio-8080-exec-8] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997441999)
2020-05-09 12:10:43.061 DEBUG 6520 --- [nio-8080-exec-6] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997441999)
2020-05-09 12:10:43.061  INFO 6520 --- [enerContainer-2] c.c.g.s.s.c.common.CacheMessageListener  : [RedisTopicMessage] clear local cache, instanceId=e6c052d5a91349b79f87d5da651aadb4, cacheName=userCache, key=cck
2020-05-09 12:10:43.061  INFO 6520 --- [enerContainer-3] c.c.g.s.s.c.common.CacheMessageListener  : [RedisTopicMessage] clear local cache, instanceId=e6c052d5a91349b79f87d5da651aadb4, cacheName=userCache, key=cck
2020-05-09 12:10:43.062  INFO 6520 --- [enerContainer-2] c.c.g.s.s.c.common.CacheMessageListener  : [RedisTopicMessage] the same instanceId not clear local cache, instanceId=e6c052d5a91349b79f87d5da651aadb4
2020-05-09 12:10:43.062  INFO 6520 --- [enerContainer-3] c.c.g.s.s.c.common.CacheMessageListener  : [RedisTopicMessage] the same instanceId not clear local cache, instanceId=e6c052d5a91349b79f87d5da651aadb4
2020-05-09 12:10:43.064 DEBUG 6520 --- [io-8080-exec-10] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997441999)
2020-05-09 12:10:43.064 DEBUG 6520 --- [nio-8080-exec-1] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997441999)
2020-05-09 12:10:43.200  INFO 6520 --- [nio-8080-exec-2] c.c.g.s.s.cache.CaffeineCacheService     : 加载数据:User(name=cck, addr=addr, currTime=1588997442199)
2020-05-09 12:10:43.200 DEBUG 6520 --- [nio-8080-exec-2] c.c.g.s.s.c.common.CaffeineRedisCache    : put cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997442199)
2020-05-09 12:10:43.202  INFO 6520 --- [enerContainer-4] c.c.g.s.s.c.common.CacheMessageListener  : [RedisTopicMessage] clear local cache, instanceId=e6c052d5a91349b79f87d5da651aadb4, cacheName=userCache, key=cck
2020-05-09 12:10:43.203  INFO 6520 --- [enerContainer-4] c.c.g.s.s.c.common.CacheMessageListener  : [RedisTopicMessage] the same instanceId not clear local cache, instanceId=e6c052d5a91349b79f87d5da651aadb4
2020-05-09 12:10:43.205 DEBUG 6520 --- [nio-8080-exec-7] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997442199)
2020-05-09 12:10:43.208 DEBUG 6520 --- [nio-8080-exec-6] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997442199)
2020-05-09 12:10:43.210 DEBUG 6520 --- [nio-8080-exec-8] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997442199)
2020-05-09 12:10:43.211 DEBUG 6520 --- [io-8080-exec-10] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997442199)
2020-05-09 12:10:43.213 DEBUG 6520 --- [nio-8080-exec-1] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997442199)
2020-05-09 12:10:43.215 DEBUG 6520 --- [nio-8080-exec-3] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997442199)
2020-05-09 12:10:43.217 DEBUG 6520 --- [nio-8080-exec-9] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997442199)
2020-05-09 12:10:43.219 DEBUG 6520 --- [nio-8080-exec-2] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997442199)
2020-05-09 12:10:43.220 DEBUG 6520 --- [nio-8080-exec-7] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997442199)
2020-05-09 12:10:43.398  INFO 6520 --- [nio-8080-exec-4] c.c.g.s.s.cache.CaffeineCacheService     : 加载数据:User(name=cck, addr=addr, currTime=1588997442398)
2020-05-09 12:10:43.398 DEBUG 6520 --- [nio-8080-exec-4] c.c.g.s.s.c.common.CaffeineRedisCache    : put cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997442398)
2020-05-09 12:10:43.400  INFO 6520 --- [enerContainer-5] c.c.g.s.s.c.common.CacheMessageListener  : [RedisTopicMessage] clear local cache, instanceId=e6c052d5a91349b79f87d5da651aadb4, cacheName=userCache, key=cck
2020-05-09 12:10:43.400  INFO 6520 --- [enerContainer-5] c.c.g.s.s.c.common.CacheMessageListener  : [RedisTopicMessage] the same instanceId not clear local cache, instanceId=e6c052d5a91349b79f87d5da651aadb4
2020-05-09 12:10:43.402 DEBUG 6520 --- [nio-8080-exec-8] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997442398)
2020-05-09 12:10:43.404 DEBUG 6520 --- [io-8080-exec-10] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997442398)
2020-05-09 12:10:43.406 DEBUG 6520 --- [nio-8080-exec-1] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997442398)
2020-05-09 12:10:43.407 DEBUG 6520 --- [nio-8080-exec-3] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997442398)
2020-05-09 12:10:43.408 DEBUG 6520 --- [nio-8080-exec-9] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997442398)
2020-05-09 12:10:43.410 DEBUG 6520 --- [nio-8080-exec-2] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997442398)
2020-05-09 12:10:43.413 DEBUG 6520 --- [nio-8080-exec-7] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997442398)
2020-05-09 12:10:43.416 DEBUG 6520 --- [nio-8080-exec-6] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997442398)
2020-05-09 12:10:43.417 DEBUG 6520 --- [nio-8080-exec-4] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997442398)
2020-05-09 12:10:43.599  INFO 6520 --- [nio-8080-exec-5] c.c.g.s.s.cache.CaffeineCacheService     : 加载数据:User(name=cck, addr=addr, currTime=1588997442598)
2020-05-09 12:10:43.599 DEBUG 6520 --- [nio-8080-exec-5] c.c.g.s.s.c.common.CaffeineRedisCache    : put cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997442598)
2020-05-09 12:10:43.601  INFO 6520 --- [enerContainer-6] c.c.g.s.s.c.common.CacheMessageListener  : [RedisTopicMessage] clear local cache, instanceId=e6c052d5a91349b79f87d5da651aadb4, cacheName=userCache, key=cck
2020-05-09 12:10:43.601  INFO 6520 --- [enerContainer-6] c.c.g.s.s.c.common.CacheMessageListener  : [RedisTopicMessage] the same instanceId not clear local cache, instanceId=e6c052d5a91349b79f87d5da651aadb4
2020-05-09 12:10:43.602 DEBUG 6520 --- [io-8080-exec-10] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997442598)
2020-05-09 12:10:43.604 DEBUG 6520 --- [nio-8080-exec-1] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997442598)
2020-05-09 12:10:43.605 DEBUG 6520 --- [nio-8080-exec-3] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997442598)
2020-05-09 12:10:43.607 DEBUG 6520 --- [nio-8080-exec-9] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997442598)
2020-05-09 12:10:43.608 DEBUG 6520 --- [nio-8080-exec-2] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997442598)
2020-05-09 12:10:43.610 DEBUG 6520 --- [nio-8080-exec-7] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997442598)
2020-05-09 12:10:43.611 DEBUG 6520 --- [nio-8080-exec-6] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997442598)
2020-05-09 12:10:43.612 DEBUG 6520 --- [nio-8080-exec-4] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997442598)
2020-05-09 12:10:43.614 DEBUG 6520 --- [nio-8080-exec-8] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997442598)
```

### 第二次获取缓存(缓存项已过期)
```text
2020-05-09 12:14:42.082  INFO 6520 --- [onPool-worker-2] c.c.g.s.s.c.c.CacheAutoConfiguration     : [LoadingCache] exec default CacheLoader.load() return null, key=cck
2020-05-09 12:14:42.089 DEBUG 6520 --- [io-8080-exec-10] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997442598)
2020-05-09 12:14:42.091  INFO 6520 --- [nio-8080-exec-1] c.c.g.s.s.c.c.CacheAutoConfiguration     : [LoadingCache] exec default CacheLoader.load() return null, key=cck
2020-05-09 12:14:42.091 DEBUG 6520 --- [nio-8080-exec-1] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=null
2020-05-09 12:14:42.277  INFO 6520 --- [nio-8080-exec-3] c.c.g.s.s.c.c.CacheAutoConfiguration     : [LoadingCache] exec default CacheLoader.load() return null, key=cck
2020-05-09 12:14:42.277 DEBUG 6520 --- [nio-8080-exec-3] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=null
2020-05-09 12:14:42.478  INFO 6520 --- [nio-8080-exec-9] c.c.g.s.s.c.c.CacheAutoConfiguration     : [LoadingCache] exec default CacheLoader.load() return null, key=cck
2020-05-09 12:14:42.478 DEBUG 6520 --- [nio-8080-exec-9] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=null
2020-05-09 12:14:42.678  INFO 6520 --- [nio-8080-exec-2] c.c.g.s.s.c.c.CacheAutoConfiguration     : [LoadingCache] exec default CacheLoader.load() return null, key=cck
2020-05-09 12:14:42.678 DEBUG 6520 --- [nio-8080-exec-2] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=null
2020-05-09 12:14:42.878  INFO 6520 --- [nio-8080-exec-7] c.c.g.s.s.c.c.CacheAutoConfiguration     : [LoadingCache] exec default CacheLoader.load() return null, key=cck
2020-05-09 12:14:42.878 DEBUG 6520 --- [nio-8080-exec-7] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=null
2020-05-09 12:14:43.091  INFO 6520 --- [nio-8080-exec-1] c.c.g.s.s.cache.CaffeineCacheService     : 加载数据:User(name=cck, addr=addr, currTime=1588997682091)
2020-05-09 12:14:43.091 DEBUG 6520 --- [nio-8080-exec-1] c.c.g.s.s.c.common.CaffeineRedisCache    : put cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682091)
2020-05-09 12:14:43.093  INFO 6520 --- [enerContainer-7] c.c.g.s.s.c.common.CacheMessageListener  : [RedisTopicMessage] clear local cache, instanceId=e6c052d5a91349b79f87d5da651aadb4, cacheName=userCache, key=cck
2020-05-09 12:14:43.093  INFO 6520 --- [enerContainer-7] c.c.g.s.s.c.common.CacheMessageListener  : [RedisTopicMessage] the same instanceId not clear local cache, instanceId=e6c052d5a91349b79f87d5da651aadb4
2020-05-09 12:14:43.095 DEBUG 6520 --- [nio-8080-exec-6] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682091)
2020-05-09 12:14:43.097 DEBUG 6520 --- [nio-8080-exec-4] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682091)
2020-05-09 12:14:43.099 DEBUG 6520 --- [nio-8080-exec-8] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682091)
2020-05-09 12:14:43.101 DEBUG 6520 --- [nio-8080-exec-5] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682091)
2020-05-09 12:14:43.102 DEBUG 6520 --- [io-8080-exec-10] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682091)
2020-05-09 12:14:43.103 DEBUG 6520 --- [nio-8080-exec-1] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682091)
2020-05-09 12:14:43.105 DEBUG 6520 --- [nio-8080-exec-6] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682091)
2020-05-09 12:14:43.106 DEBUG 6520 --- [nio-8080-exec-4] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682091)
2020-05-09 12:14:43.278  INFO 6520 --- [nio-8080-exec-3] c.c.g.s.s.cache.CaffeineCacheService     : 加载数据:User(name=cck, addr=addr, currTime=1588997682277)
2020-05-09 12:14:43.278 DEBUG 6520 --- [nio-8080-exec-3] c.c.g.s.s.c.common.CaffeineRedisCache    : put cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682277)
2020-05-09 12:14:43.280  INFO 6520 --- [enerContainer-8] c.c.g.s.s.c.common.CacheMessageListener  : [RedisTopicMessage] clear local cache, instanceId=e6c052d5a91349b79f87d5da651aadb4, cacheName=userCache, key=cck
2020-05-09 12:14:43.281  INFO 6520 --- [enerContainer-8] c.c.g.s.s.c.common.CacheMessageListener  : [RedisTopicMessage] the same instanceId not clear local cache, instanceId=e6c052d5a91349b79f87d5da651aadb4
2020-05-09 12:14:43.282 DEBUG 6520 --- [nio-8080-exec-3] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682277)
2020-05-09 12:14:43.283 DEBUG 6520 --- [nio-8080-exec-5] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682277)
2020-05-09 12:14:43.285 DEBUG 6520 --- [io-8080-exec-10] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682277)
2020-05-09 12:14:43.286 DEBUG 6520 --- [nio-8080-exec-1] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682277)
2020-05-09 12:14:43.288 DEBUG 6520 --- [nio-8080-exec-6] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682277)
2020-05-09 12:14:43.289 DEBUG 6520 --- [nio-8080-exec-4] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682277)
2020-05-09 12:14:43.290 DEBUG 6520 --- [nio-8080-exec-8] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682277)
2020-05-09 12:14:43.291 DEBUG 6520 --- [nio-8080-exec-3] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682277)
2020-05-09 12:14:43.292 DEBUG 6520 --- [nio-8080-exec-5] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682277)
2020-05-09 12:14:43.479  INFO 6520 --- [nio-8080-exec-9] c.c.g.s.s.cache.CaffeineCacheService     : 加载数据:User(name=cck, addr=addr, currTime=1588997682478)
2020-05-09 12:14:43.479 DEBUG 6520 --- [nio-8080-exec-9] c.c.g.s.s.c.common.CaffeineRedisCache    : put cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682478)
2020-05-09 12:14:43.480  INFO 6520 --- [enerContainer-9] c.c.g.s.s.c.common.CacheMessageListener  : [RedisTopicMessage] clear local cache, instanceId=e6c052d5a91349b79f87d5da651aadb4, cacheName=userCache, key=cck
2020-05-09 12:14:43.481  INFO 6520 --- [enerContainer-9] c.c.g.s.s.c.common.CacheMessageListener  : [RedisTopicMessage] the same instanceId not clear local cache, instanceId=e6c052d5a91349b79f87d5da651aadb4
2020-05-09 12:14:43.482 DEBUG 6520 --- [nio-8080-exec-1] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682478)
2020-05-09 12:14:43.484 DEBUG 6520 --- [nio-8080-exec-6] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682478)
2020-05-09 12:14:43.486 DEBUG 6520 --- [nio-8080-exec-4] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682478)
2020-05-09 12:14:43.486 DEBUG 6520 --- [nio-8080-exec-8] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682478)
2020-05-09 12:14:43.488 DEBUG 6520 --- [nio-8080-exec-3] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682478)
2020-05-09 12:14:43.490 DEBUG 6520 --- [nio-8080-exec-5] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682478)
2020-05-09 12:14:43.491 DEBUG 6520 --- [io-8080-exec-10] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682478)
2020-05-09 12:14:43.493 DEBUG 6520 --- [nio-8080-exec-9] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682478)
2020-05-09 12:14:43.494 DEBUG 6520 --- [nio-8080-exec-1] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682478)
2020-05-09 12:14:43.678  INFO 6520 --- [nio-8080-exec-2] c.c.g.s.s.cache.CaffeineCacheService     : 加载数据:User(name=cck, addr=addr, currTime=1588997682678)
2020-05-09 12:14:43.678 DEBUG 6520 --- [nio-8080-exec-2] c.c.g.s.s.c.common.CaffeineRedisCache    : put cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682678)
2020-05-09 12:14:43.681  INFO 6520 --- [nerContainer-10] c.c.g.s.s.c.common.CacheMessageListener  : [RedisTopicMessage] clear local cache, instanceId=e6c052d5a91349b79f87d5da651aadb4, cacheName=userCache, key=cck
2020-05-09 12:14:43.681  INFO 6520 --- [nerContainer-10] c.c.g.s.s.c.common.CacheMessageListener  : [RedisTopicMessage] the same instanceId not clear local cache, instanceId=e6c052d5a91349b79f87d5da651aadb4
2020-05-09 12:14:43.683 DEBUG 6520 --- [nio-8080-exec-4] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682678)
2020-05-09 12:14:43.685 DEBUG 6520 --- [nio-8080-exec-8] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682678)
2020-05-09 12:14:43.686 DEBUG 6520 --- [nio-8080-exec-3] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682678)
2020-05-09 12:14:43.688 DEBUG 6520 --- [nio-8080-exec-5] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682678)
2020-05-09 12:14:43.690 DEBUG 6520 --- [io-8080-exec-10] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682678)
2020-05-09 12:14:43.691 DEBUG 6520 --- [nio-8080-exec-9] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682678)
2020-05-09 12:14:43.693 DEBUG 6520 --- [nio-8080-exec-1] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682678)
2020-05-09 12:14:43.694 DEBUG 6520 --- [nio-8080-exec-6] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682678)
2020-05-09 12:14:43.696 DEBUG 6520 --- [nio-8080-exec-2] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682678)
2020-05-09 12:14:43.879  INFO 6520 --- [nio-8080-exec-7] c.c.g.s.s.cache.CaffeineCacheService     : 加载数据:User(name=cck, addr=addr, currTime=1588997682878)
2020-05-09 12:14:43.879 DEBUG 6520 --- [nio-8080-exec-7] c.c.g.s.s.c.common.CaffeineRedisCache    : put cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682878)
2020-05-09 12:14:43.882  INFO 6520 --- [nerContainer-11] c.c.g.s.s.c.common.CacheMessageListener  : [RedisTopicMessage] clear local cache, instanceId=e6c052d5a91349b79f87d5da651aadb4, cacheName=userCache, key=cck
2020-05-09 12:14:43.882  INFO 6520 --- [nerContainer-11] c.c.g.s.s.c.common.CacheMessageListener  : [RedisTopicMessage] the same instanceId not clear local cache, instanceId=e6c052d5a91349b79f87d5da651aadb4
2020-05-09 12:14:43.883 DEBUG 6520 --- [nio-8080-exec-8] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682878)
2020-05-09 12:14:43.884 DEBUG 6520 --- [nio-8080-exec-3] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682878)
2020-05-09 12:14:43.885 DEBUG 6520 --- [nio-8080-exec-5] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682878)
2020-05-09 12:14:43.886 DEBUG 6520 --- [io-8080-exec-10] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682878)
2020-05-09 12:14:43.887 DEBUG 6520 --- [nio-8080-exec-9] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682878)
2020-05-09 12:14:43.888 DEBUG 6520 --- [nio-8080-exec-1] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682878)
2020-05-09 12:14:43.890 DEBUG 6520 --- [nio-8080-exec-6] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682878)
2020-05-09 12:14:43.891 DEBUG 6520 --- [nio-8080-exec-2] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682878)
2020-05-09 12:14:43.891 DEBUG 6520 --- [nio-8080-exec-4] c.c.g.s.s.c.common.CaffeineRedisCache    : LoadingCache.get cache, key=cck, value=User(name=cck, addr=addr, currTime=1588997682878)
```


# 场景2 - 同步方式加载数据 【建议】
## 配置
```yaml
spring:
  application:
    name: study-spring-demo
  cache:
    multi:
      # 一级缓存
      caffeine:
        spec: initialCapacity=10,maximumSize=200,refreshAfterWrite=30s
      # 二级缓存
      redis:
        defaultTimeToLive: 1000
        # 设置缓存名称的过期时间(毫秒)
        expires:
          userCache: 30000
          userCacheSync: 30000
```

```text
// sync=true,即采用同步方式加载数据
@Cacheable(value = "userCacheSync", key = "#userId", sync = true)
public User queryUserSync(String userId) {
    User user = new User(userId, "addr");
    try {
        Thread.sleep(2000);// 模拟加载数据的耗时
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
    logger.info("加载数据:{}", user);
    return user;
}
```

## 测试结果
> sync=true,即采用同步方式加载数据。
> 
> 通过分析下面的日志发现，存在如下问题：
>
> 只有一个线程加载数据，其他线程均被阻塞。虽然解决了缓存击穿的问题，但是在高并发场景下因为阻塞带来的性能问题。
> 奇怪的是使用`refreshAfterWrite`策略，正常情况下应该只有加载数据的线程会阻塞，其他线程应该返回旧值才对，但是通过日志反应出来的结果却是其他线程被阻塞了。why?
> 
>


## 测试日志
### 第一次获取缓存(无缓存项)
> 只有一个线程加载数据，其他线程均被阻塞。
```text

2020-05-09 12:59:22.886 DEBUG 26172 --- [nio-8080-exec-1] c.c.g.s.s.c.common.CaffeineRedisCache    : [LoadFunction] load cache, key=cck
2020-05-09 12:59:24.899  INFO 26172 --- [nio-8080-exec-1] c.c.g.s.s.cache.CaffeineCacheService     : 加载数据:User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:24.899 DEBUG 26172 --- [nio-8080-exec-1] c.c.g.s.s.c.common.CaffeineRedisCache    : [LoadFunction] load cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:24.942 DEBUG 26172 --- [nio-8080-exec-3] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:24.942 DEBUG 26172 --- [nio-8080-exec-4] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:24.942 DEBUG 26172 --- [nio-8080-exec-2] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:24.944 DEBUG 26172 --- [nio-8080-exec-1] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:24.946 DEBUG 26172 --- [nio-8080-exec-5] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:24.986 DEBUG 26172 --- [io-8080-exec-10] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:24.986 DEBUG 26172 --- [nio-8080-exec-8] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:24.986 DEBUG 26172 --- [nio-8080-exec-9] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:24.986 DEBUG 26172 --- [nio-8080-exec-1] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:24.986 DEBUG 26172 --- [nio-8080-exec-7] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:24.991 DEBUG 26172 --- [nio-8080-exec-8] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:24.991 DEBUG 26172 --- [nio-8080-exec-4] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:24.991 DEBUG 26172 --- [nio-8080-exec-7] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:24.991 DEBUG 26172 --- [nio-8080-exec-9] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:24.991 DEBUG 26172 --- [nio-8080-exec-6] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:24.994 DEBUG 26172 --- [nio-8080-exec-7] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:24.994 DEBUG 26172 --- [nio-8080-exec-3] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:24.994 DEBUG 26172 --- [nio-8080-exec-6] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:24.994 DEBUG 26172 --- [nio-8080-exec-1] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:24.994 DEBUG 26172 --- [nio-8080-exec-9] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:24.997 DEBUG 26172 --- [nio-8080-exec-3] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:24.997 DEBUG 26172 --- [nio-8080-exec-2] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:24.997 DEBUG 26172 --- [nio-8080-exec-4] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:24.997 DEBUG 26172 --- [nio-8080-exec-8] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:24.997 DEBUG 26172 --- [nio-8080-exec-5] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:24.999 DEBUG 26172 --- [io-8080-exec-10] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:24.999 DEBUG 26172 --- [nio-8080-exec-7] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:24.999 DEBUG 26172 --- [nio-8080-exec-9] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:25.000 DEBUG 26172 --- [nio-8080-exec-6] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:25.000 DEBUG 26172 --- [nio-8080-exec-1] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:25.002 DEBUG 26172 --- [nio-8080-exec-5] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:25.002 DEBUG 26172 --- [nio-8080-exec-2] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:25.002 DEBUG 26172 --- [nio-8080-exec-4] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:25.002 DEBUG 26172 --- [nio-8080-exec-3] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:25.002 DEBUG 26172 --- [nio-8080-exec-8] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:25.004 DEBUG 26172 --- [nio-8080-exec-9] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:25.004 DEBUG 26172 --- [nio-8080-exec-7] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:25.004 DEBUG 26172 --- [nio-8080-exec-6] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:25.004 DEBUG 26172 --- [nio-8080-exec-1] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:25.004 DEBUG 26172 --- [io-8080-exec-10] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:25.006  INFO 26172 --- [enerContainer-2] c.c.g.s.s.c.common.CacheMessageListener  : [RedisTopicMessage] clear local cache, instanceId=264b70e32ef34b8ea10e809711cdf806, cacheName=userCacheSync, key=cck
2020-05-09 12:59:25.006  INFO 26172 --- [enerContainer-2] c.c.g.s.s.c.common.CacheMessageListener  : [RedisTopicMessage] the same instanceId not clear local cache, instanceId=264b70e32ef34b8ea10e809711cdf806
2020-05-09 12:59:25.007 DEBUG 26172 --- [nio-8080-exec-4] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:25.007 DEBUG 26172 --- [nio-8080-exec-5] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:25.007 DEBUG 26172 --- [nio-8080-exec-2] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:25.007 DEBUG 26172 --- [nio-8080-exec-3] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:25.007 DEBUG 26172 --- [nio-8080-exec-8] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:25.009 DEBUG 26172 --- [io-8080-exec-10] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:25.009 DEBUG 26172 --- [nio-8080-exec-1] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:25.009 DEBUG 26172 --- [nio-8080-exec-6] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:25.009 DEBUG 26172 --- [nio-8080-exec-9] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 12:59:25.009 DEBUG 26172 --- [nio-8080-exec-7] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)

```

### 第二次获取缓存(缓存项已过期)
> 只有一个线程加载数据，其他线程均被阻塞。
```text

2020-05-09 13:01:04.210  INFO 26172 --- [onPool-worker-2] c.c.g.s.s.c.c.CacheAutoConfiguration     : [LoadingCache] exec default CacheLoader.load() return null, key=cck
2020-05-09 13:01:04.217 DEBUG 26172 --- [nio-8080-exec-1] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000362899)
2020-05-09 13:01:04.220 DEBUG 26172 --- [io-8080-exec-10] c.c.g.s.s.c.common.CaffeineRedisCache    : [LoadFunction] load cache, key=cck
2020-05-09 13:01:06.222  INFO 26172 --- [io-8080-exec-10] c.c.g.s.s.cache.CaffeineCacheService     : 加载数据:User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.222 DEBUG 26172 --- [io-8080-exec-10] c.c.g.s.s.c.common.CaffeineRedisCache    : [LoadFunction] load cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.224 DEBUG 26172 --- [nio-8080-exec-7] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.224 DEBUG 26172 --- [nio-8080-exec-8] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.224 DEBUG 26172 --- [nio-8080-exec-9] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.225 DEBUG 26172 --- [nio-8080-exec-6] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.224 DEBUG 26172 --- [io-8080-exec-10] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.225  INFO 26172 --- [enerContainer-3] c.c.g.s.s.c.common.CacheMessageListener  : [RedisTopicMessage] clear local cache, instanceId=264b70e32ef34b8ea10e809711cdf806, cacheName=userCacheSync, key=cck
2020-05-09 13:01:06.225  INFO 26172 --- [enerContainer-3] c.c.g.s.s.c.common.CacheMessageListener  : [RedisTopicMessage] the same instanceId not clear local cache, instanceId=264b70e32ef34b8ea10e809711cdf806
2020-05-09 13:01:06.228 DEBUG 26172 --- [nio-8080-exec-1] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.228 DEBUG 26172 --- [nio-8080-exec-7] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.228 DEBUG 26172 --- [nio-8080-exec-3] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.228 DEBUG 26172 --- [nio-8080-exec-2] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.228 DEBUG 26172 --- [nio-8080-exec-4] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.231 DEBUG 26172 --- [nio-8080-exec-6] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.231 DEBUG 26172 --- [nio-8080-exec-9] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.231 DEBUG 26172 --- [nio-8080-exec-8] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.231 DEBUG 26172 --- [nio-8080-exec-5] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.231 DEBUG 26172 --- [io-8080-exec-10] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.233 DEBUG 26172 --- [nio-8080-exec-4] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.233 DEBUG 26172 --- [nio-8080-exec-2] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.233 DEBUG 26172 --- [nio-8080-exec-7] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.233 DEBUG 26172 --- [nio-8080-exec-1] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.233 DEBUG 26172 --- [nio-8080-exec-3] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.235 DEBUG 26172 --- [nio-8080-exec-8] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.235 DEBUG 26172 --- [nio-8080-exec-9] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.235 DEBUG 26172 --- [nio-8080-exec-5] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.235 DEBUG 26172 --- [io-8080-exec-10] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.235 DEBUG 26172 --- [nio-8080-exec-6] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.238 DEBUG 26172 --- [nio-8080-exec-7] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.238 DEBUG 26172 --- [nio-8080-exec-3] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.238 DEBUG 26172 --- [nio-8080-exec-8] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.238 DEBUG 26172 --- [nio-8080-exec-1] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.238 DEBUG 26172 --- [nio-8080-exec-2] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.240 DEBUG 26172 --- [nio-8080-exec-5] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.240 DEBUG 26172 --- [nio-8080-exec-4] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.240 DEBUG 26172 --- [nio-8080-exec-6] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.240 DEBUG 26172 --- [io-8080-exec-10] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.240 DEBUG 26172 --- [nio-8080-exec-9] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.242 DEBUG 26172 --- [nio-8080-exec-1] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.242 DEBUG 26172 --- [nio-8080-exec-7] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.242 DEBUG 26172 --- [nio-8080-exec-2] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.242 DEBUG 26172 --- [nio-8080-exec-8] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.242 DEBUG 26172 --- [nio-8080-exec-3] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.244 DEBUG 26172 --- [nio-8080-exec-5] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.244 DEBUG 26172 --- [nio-8080-exec-4] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.244 DEBUG 26172 --- [nio-8080-exec-3] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.244 DEBUG 26172 --- [nio-8080-exec-9] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.244 DEBUG 26172 --- [io-8080-exec-10] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.246 DEBUG 26172 --- [nio-8080-exec-2] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.246 DEBUG 26172 --- [nio-8080-exec-7] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.246 DEBUG 26172 --- [nio-8080-exec-1] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)
2020-05-09 13:01:06.246 DEBUG 26172 --- [nio-8080-exec-6] c.c.g.s.s.c.common.CaffeineRedisCache    : get(key, callable) cache, key=cck, value=User(name=cck, addr=addr, currTime=1589000464222)

```